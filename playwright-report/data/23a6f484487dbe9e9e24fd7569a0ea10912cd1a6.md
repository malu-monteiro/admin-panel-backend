# Test info

- Name: Password Tests >> Full password reset flow
- Location: D:\DEV\trabalhos\painel-admin\backend\src\tests\password.e2e-spec.ts:65:7

# Error details

```
Error: expect(received).toBe(expected) // Object.is equality

Expected: 200
Received: 500
    at D:\DEV\trabalhos\painel-admin\backend\src\tests\password.e2e-spec.ts:78:37
```

# Test source

```ts
   1 | // Versão corrigida do seu teste de password reset
   2 |
   3 | import { test, expect } from "@playwright/test";
   4 | import { hash } from "bcryptjs";
   5 | import prisma from "../prisma";
   6 | import { PrismaClientKnownRequestError } from "@prisma/client/runtime/library";
   7 |
   8 | const API_URL = "http://localhost:3000/api";
   9 |
   10 | test.describe("Password Tests", () => {
   11 |   let testAdmin: { id: string; email: string };
   12 |
   13 |   test.beforeAll(async () => {
   14 |     // Garanta que o NODE_ENV está configurado como test
   15 |     process.env.NODE_ENV = "test";
   16 |
   17 |     // Cleanup e criação do admin de teste
   18 |     await prisma.passwordResetToken.deleteMany();
   19 |     await prisma.admin.deleteMany();
   20 |
   21 |     const uniqueEmail = `password-test-${Date.now()}@example.com`;
   22 |     testAdmin = await prisma.admin.create({
   23 |       data: {
   24 |         email: uniqueEmail,
   25 |         password: await hash("originalPassword123", 10),
   26 |         emailVerified: true,
   27 |       },
   28 |     });
   29 |   });
   30 |
   31 |   test.afterEach(async () => {
   32 |     try {
   33 |       // Limpeza de tokens e redefinição de senha do admin
   34 |       await prisma.passwordResetToken.deleteMany();
   35 |
   36 |       const adminExists = await prisma.admin.findUnique({
   37 |         where: { id: testAdmin.id },
   38 |       });
   39 |       if (adminExists) {
   40 |         await prisma.admin.update({
   41 |           where: { id: testAdmin.id },
   42 |           data: { password: await hash("originalPassword123", 10) },
   43 |         });
   44 |       }
   45 |     } catch (error) {
   46 |       if (
   47 |         error instanceof PrismaClientKnownRequestError &&
   48 |         error.code === "P2025"
   49 |       ) {
   50 |         console.log(
   51 |           "Admin not found during cleanup. This may indicate a test issue."
   52 |         );
   53 |       } else {
   54 |         console.error("Cleanup error:", error);
   55 |       }
   56 |     }
   57 |   });
   58 |
   59 |   test.afterAll(async () => {
   60 |     // Limpeza final
   61 |     await prisma.passwordResetToken.deleteMany();
   62 |     await prisma.admin.deleteMany();
   63 |   });
   64 |
   65 |   test("Full password reset flow", async ({ request }) => {
   66 |     // Passo 1: Acionar a recuperação de senha
   67 |     const forgotResponse = await request.post(`${API_URL}/forgot-password`, {
   68 |       data: { email: testAdmin.email },
   69 |     });
   70 |
   71 |     // Log da resposta para debug
   72 |     const forgotResponseBody = await forgotResponse.json();
   73 |     console.log("Forgot Password Response:", {
   74 |       status: forgotResponse.status(),
   75 |       body: forgotResponseBody,
   76 |     });
   77 |
>  78 |     expect(forgotResponse.status()).toBe(200);
      |                                     ^ Error: expect(received).toBe(expected) // Object.is equality
   79 |
   80 |     // Passo 2: Recuperar o token gerado
   81 |     const resetTokenRecord = await prisma.passwordResetToken.findFirst({
   82 |       where: { adminId: testAdmin.id },
   83 |     });
   84 |
   85 |     if (!resetTokenRecord) {
   86 |       throw new Error("Reset token not found after forgot password request");
   87 |     }
   88 |
   89 |     const resetToken = resetTokenRecord.token;
   90 |
   91 |     // Passo 3: Redefinir a senha
   92 |     const resetResponse = await request.post(`${API_URL}/reset-password`, {
   93 |       data: {
   94 |         token: resetToken,
   95 |         newPassword: "NewSecure123!",
   96 |       },
   97 |     });
   98 |
   99 |     expect(resetResponse.status()).toBe(200);
  100 |
  101 |     // Passo 4: Verificar se a nova senha funciona
  102 |     const loginResponse = await request.post(`${API_URL}/login`, {
  103 |       data: {
  104 |         email: testAdmin.email,
  105 |         password: "NewSecure123!",
  106 |       },
  107 |     });
  108 |
  109 |     expect(loginResponse.status()).toBe(200);
  110 |   });
  111 |
  112 |   test("Update password with invalid current password", async ({ request }) => {
  113 |     const login = await request.post(`${API_URL}/login`, {
  114 |       data: {
  115 |         email: testAdmin.email,
  116 |         password: "originalPassword123",
  117 |       },
  118 |     });
  119 |
  120 |     const { token } = await login.json();
  121 |
  122 |     const response = await request.patch(`${API_URL}/update-password`, {
  123 |       headers: { Authorization: `Bearer ${token}` },
  124 |       data: {
  125 |         currentPassword: "wrongPassword",
  126 |         newPassword: "newPassword123",
  127 |       },
  128 |     });
  129 |
  130 |     expect(response.status()).toBe(401);
  131 |   });
  132 | });
  133 |
```